📖 레거시 코드 인수 테스트
레거시 코드 인수 테스트
“이 프로젝트에는 테스트가 하나도 없습니다.”
우리가 리팩터링을 두려워하는 이유

우리가 리팩터링을 두려워하는 이유는 무엇일까요?
    코드가 복잡해서?
    로직이 얽혀 있어서?
    테스트가 없어서?
    "내가 뭔가를 깨뜨렸는데, 그걸 모를까 봐."

레거시의 정의
    "Legacy code is code without tests."
    --- Michael Feathers

우리는 무엇을 보호해야 할까요?
    코드?
    클래스 구조?
    메서드?
    아니면 사용자 행동?

리팩터링의 정의
    Refactoring is restructuring without changing external behavior
    --- Martin Fowler

핵심은 external behavior입니다.
External Behavior란 무엇인가
ex)
    주문하면 주문이 생성되어야 한다.
    결제하면 잔액이 차감되어야 한다.
    선물을 보내면 재고가 줄어야 한다.

External Behavior란 무엇인가
    HTTP 응답
    예외 타입
    DB 상태
    비즈니스 결과

"이러한 외부 행동을 보호하려면?"
단위 테스트는 무엇을 보호하는가

단위 테스트는 보통 다음을 보호합니다:
    메서드 반환값
    조건 분기
    예외 발생
    Mock 호출 여부

“선물을 보내면 재고가 감소한다.”
단위 테스트의 착시

verify(option).decrease(3);

"그렇다면 우리는 무엇을 검증해야 할까요?"
시스템은 어디에서 깨지는가
    트랜잭션 경계 변경
    영속성 컨텍스트 오해
    도메인 로직 누락
    flush/clear 누락
    예외 타입 변경

행동 기반 테스트란

행동 기반 테스트는:
    시스템 경계(API)에서
    사용자 시나리오를
    최종 상태 기준으로
    검증합니다

왜 API 경계인가
    UI 변경에 덜 민감
    도메인 계약 검증 가능
    FE/BE/데이터 직군 모두 이해 가능

보호의 대상
보호 대상은
    decrease() 호출이 아니다.
    재고 감소 결과이다.

AI 시대와의 연결
AI는 빠르게 코드를 바꿉니다.
하지만 비즈니스 행동을 보장하지는 않습니다.
    그래서 우리는 행동을 고정하는 테스트가 필요합니다.

오늘 데모에서 볼 것

시나리오: InventoryService 도입 리팩터링
    두 가지 테스트 (단위 vs 인수)
    리팩터링 실행 (책임 분리)
    단위 테스트는 실패, 인수 테스트는 통과
    리팩터링 안전망의 가치
    "어떤 테스트가 진짜 리팩터링을 보호하는가?"


요구사항
클로드 코드(또는 AI 도구)를 활용하여 프로젝트의 핵심 기능을 파악하고, 사용자 관점에서 행위를 검증하는 테스트를 작성하세요.

페어와 함께 진행하며, 논의 내용을 문서로 남기세요.
제약 조건
    BDD 도구(Cucumber, Karate 등)를 사용하지 않습니다.

제출물
1. 테스트 전략 문서 (TEST_STRATEGY.md)
   검증할 행위 목록: 어떤 행위를 선택했는가? 기준은?
   테스트 데이터 전략: 어떻게 준비하고 정리하는가?
   검증 전략: 무엇을 어떻게 검증하는가?
   주요 의사결정: 논의 과정에서 중요한 선택과 이유
2. 테스트 코드
   최소 5개 이상의 행위를 검증하는 테스트
   최소 5개의 행위를 검증하는 것이지 테스트가 5개라는 말은 아닙니다.
3. 프롬프트 및 AI 활용 방법 문서
   클로드 코드(또는 AI 도구)를 활용한 방법을 문서로 제출하세요.
   프롬프트나 접근 방법 혹은 정의한 스킬들을 문서에 포함해주세요.

힌트
클로드 코드에게 물어보세요
    "이 프로젝트의 핵심 기능을 분석해줘"
    "사용자가 할 수 있는 행동은 뭐가 있어?"
    "재고가 변경되는 흐름을 보여줘"
페어와 함께 고민하세요
    무엇을 테스트할 것인가?
    이 시스템의 핵심 기능은?
    어떤 행위가 테스트할 가치가 있는가?
    성공/실패 시나리오 중 무엇이 중요한가?
테스트 데이터는 어떻게 준비할 것인가?
    초기 상태를 어떻게 설정하는가?
    API로 준비? 다른 방법?
    테스트 간 격리는 어떻게?
무엇을 검증할 것인가?
    HTTP 응답만으로 충분한가?
    상태 변화를 어떻게 확인하는가?
    DB 직접 조회 없이 검증 가능한가?
어떤 시나리오를 만들 것인가?
    "다음 행동"으로 이전 행동을 검증할 수 있는가?
    실패 케이스를 어떻게 활용하는가?
