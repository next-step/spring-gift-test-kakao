# 인수 테스트 전략

시스템 경계(HTTP API)에서 사용자 시나리오 기준으로 테스트하며, 최종 DB 상태를 검증한다.

## 공통 의사결정

| 의사결정 | 근거 |
|----------|------|
| `@SpringBootTest` + 실제 HTTP 요청 | 인수 테스트 = 시스템 경계 테스트. MockMvc도 가능하지만 실제 서블릿 환경이 더 현실적 |
| DB 최종 상태 검증 우선 | CLAUDE.md 원칙: 최종 결과를 보호. `verify(mock)` 사용하지 않음 |
| 각 테스트가 자체 데이터 생성 | `data.sql`에 의존하면 테스트 간 결합이 생김. 각 테스트가 독립적으로 데이터 준비 |
| FakeGiftDelivery를 그대로 사용 | 유일한 구현체이며 콘솔 출력만 하므로 테스트에 부작용 없음. 별도 Mock 불필요 |
| BDD 도구 미사용 | 제약 조건에 명시. JUnit 5 + Spring Boot Test만 사용 |

## 미구현 기능 (테스트 대상 아님)

CLAUDE.md 요구사항에 기술되어 있으나 현재 코드에 구현되어 있지 않으므로 테스트 대상에서 제외한다.

- 잔액/결제 로직 (Member에 balance 필드 없음)
- 선물 취소 및 상태 전이 (Gift가 JPA 엔티티가 아니며, 상태 필드 없음)
- 선물 상태 조회

---

## 행위 1: 선물하기 (`POST /api/gifts`)

선물 요청을 보내면 재고가 차감되고, 실패 시 시스템 상태가 오염되지 않아야 한다.

### 테스트 1-1. 정상 선물 보내기

**선정 이유:** 가장 기본적인 성공 경로. 이것이 깨지면 나머지는 의미가 없다.

**테스트 데이터:**
- Category, Product, Option(quantity=10), Member 2명을 생성

**검증:**
- HTTP `200 OK`
- DB Option 재조회 → `quantity == 10 - 요청수량`

**의사결정:**
- `giftDelivery.deliver()` 호출 여부는 검증하지 않음 (최종 DB 상태가 보호 대상)
- 현재 엔드포인트가 `void`를 반환하므로 상태 코드만 검증

### 테스트 1-2. 재고 부족 시 실패

**선정 이유:** `Option.decrease()`의 가드 로직이 API 경계까지 전파되는지, 실패 시 트랜잭션 롤백이 정상 작동하는지 확인한다.

**테스트 데이터:**
- Option(quantity=5) 생성, 수량 10으로 선물 요청

**검증:**
- HTTP `500`
- DB Option 재조회 → `quantity == 5` (변경 없음)

**의사결정:**
- 단순히 에러 반환만으로는 불충분. 롤백 실패 시 선물 없이 재고만 줄어드는 상황이 가능하므로 **DB 최종 상태의 불변성 검증이 핵심**.

### 테스트 1-3. 재고 경계값 — 두 번째 선물이 실패

**선정 이유:** 가장 현실적인 시나리오. 재고 경계값에서 트랜잭션 커밋/롤백이 정확히 작동하는지 확인한다.

**테스트 데이터:**
- Option(quantity=**1**) 생성
- 첫 번째 요청: 수량 1 (성공 기대)
- 두 번째 요청: 수량 1 (실패 기대)

**검증:**
- 첫 번째: `200 OK` + DB quantity == 0
- 두 번째: `500` + DB quantity == 0 (음수로 내려가지 않음)

**의사결정:**
- **두 요청을 하나의 테스트에서 실행** — 상태 연속성 시나리오이므로 분리하면 의미가 없다
- **quantity == 0을 두 번 검증** — 첫 성공 후 0인지, 두 번째 실패 후에도 여전히 0인지 확인

### 테스트 1-4. 존재하지 않는 옵션으로 선물 시도

**선정 이유:** `findById().orElseThrow()` 경로 테스트. 잘못된 입력이 시스템을 오염시키지 않는지 확인한다.

**테스트 데이터:**
- 존재하지 않는 optionId(예: 999999)로 요청

**검증:**
- HTTP `500`
- (선택) 다른 Option 데이터가 있다면 해당 quantity가 변경되지 않았는지 확인

**의사결정:**
- 이 테스트 없이는 `NoSuchElementException`이 API 경계에서 예상대로 동작하는지 보장할 수 없다
