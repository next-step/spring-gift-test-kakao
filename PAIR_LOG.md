# 📝 페어 프로그래밍 및 설계 논의 기록 (PAIR_LOG.md)

## 1. 개요
- **참여 인원**: 학습자(사용자), Gemini(AI 페어)
- **주제**: `spring-gift-test-kakao` BDD 테스트 전략 수립 및 도메인 모델 개선 논의
- **기간**: 2026. 02. 20

---

## 2. 주요 논의 상세 및 결정 근거

### [논의 1] 검증 지표의 전환 (포인트 → 옵션 재고)
- **현황**: 초기 전략은 '포인트 차감'을 핵심 행위로 설정했으나, 현재 코드베이스에 포인트 관련 로직이 부재함을 발견.
- **결정**: **'옵션 재고(Quantity)' 차감**을 비즈니스 무결성 검증의 핵심 지표로 변경.
- **근거**:
    - **도메인 정합성**: 현재 시스템에서 상태 변화를 일으키는 유일한 수치 자산은 '재고'이며, 이를 검증하는 것이 시스템의 생존 여부를 판단하는 가장 확실한 방법임.
    - **비즈니스 가치**: 선물하기 서비스에서 '재고 부족 시 주문 불가'는 금전적 결제만큼이나 중요한 비즈니스 규칙임.

### [논의 2] Gift 도메인의 영속 엔티티화 (POJO → @Entity)
- **현황**: 현재 `Gift`는 메모리상에만 존재하는 POJO이며 DB에 저장되지 않아 사후 조회가 불가능함.
- **결정**: **`Gift` 클래스를 JPA 엔티티로 승격**하고 DB 영속화를 결정.
- **근거**:
    - **데이터 일관성(Integrity)**: "누가 누구에게 무엇을 보냈는가"는 서비스의 핵심 데이터이므로 영속적 관리가 필수적임.
    - **테스트 가능성(Testability)**: 선물이 정상 생성되었는지, 메시지가 오염되지 않았는지 API로 다시 꺼내 확인(Outside-In)하기 위한 기술적 전제 조건임.

### [논의 3] 검증 전용 조회 API 추가 구현
- **현황**: 현재 노출된 API만으로는 행위의 결과(재고 감소, 선물 상세 내용)를 관찰하기 어려움.
- **결정**: **`GET /api/options/{id}`, `GET /api/gifts/{id}`** 엔드포인트를 프로덕션 코드에 추가.
- **근거**:
    - **Black-box 원칙**: 내부 DB 상태를 직접 조회하는 대신, 사용자 인터페이스(API)를 통해 상태 변화를 관찰하는 것이 진정한 인수 테스트의 목적에 부합함.
    - **디자인 피드백**: 테스트를 작성하기 어려운 구조는 설계에 결함이 있다는 신호이며, 이를 개선하는 과정 자체가 TDD/BDD의 핵심 루프임.

### [논의 4] 테스트 격리 전략 수립
- **현황**: 인수 테스트는 별도 쓰레드에서 실행되므로 `@Transactional` 롤백이 적용되지 않아 데이터 오염 발생.
- **결정**: 모든 테이블을 `TRUNCATE`하는 **`DatabaseCleaner` 유틸리티** 구현.
- **근거**:
    - **테스트 신뢰성**: 각 테스트 메서드가 독립적인 상태에서 시작되어야 테스트 결과의 결정성(Determinism)을 보장할 수 있음.
    - **수행 속도**: 전체 컨텍스트를 새로 띄우는 것보다 데이터만 초기화하는 방식이 성능 면에서 유리함.

---

## 3. 프롬프트 및 AI 활용 방법 문서 (제출용)

### [AI 도구 활용 전략]
단순히 코드를 생성하는 용도가 아니라, 코드베이스의 한계를 지적하고 **설계적 트레이드오프(Trade-off)를 함께 고민하는 '시니어 페어 개발자'**로 AI를 설정함.

### [활용 단계 및 프롬프트 예시]
1. **분석**: "이 프로젝트의 `schema.sql`과 컨트롤러를 분석해줘. 여기서 가장 중요한 비즈니스 행위는 뭐야?"
2. **검수**: "내가 짠 테스트 전략 문서에서 BDD 원칙(Outside-In)에 어긋나는 부분이 있다면 비판적으로 지적해줘."
3. **해결**: "현재 Gift가 DB에 저장되지 않는데, 이를 해결하기 위해 프로덕션 코드를 어떻게 수정하는 게 테스트 가독성에 좋을까?"
4. **고도화**: "비정상 케이스(Edge case)를 행위 목록에 추가하고 싶어. 어떤 시나리오가 비즈니스적으로 가치 있을까?"

### [AI 활용의 이점]
- **객관적 피드백**: 작성자의 편향을 배제하고 Outside-In 관점에서 테스트 가능한 구조인지 끊임없이 체크함.
- **빠른 프로토타이핑**: 설계 변경 결정 후, 그에 필요한 Boilerplate 코드(Repository, Controller 뼈대 등)를 빠르게 생성하여 핵심 로직 설계에 집중할 수 있게 함.